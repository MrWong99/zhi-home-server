#!/usr/bin/env bash
# Home server backup script — generated by zhi
# Schedule with cron: 0 3 * * * /path/to/backup.sh >> /var/log/homeserver-backup.log 2>&1
set -euo pipefail

BACKUP_DIR="{{ .Get "core/backup-dir" | default "/srv/backups/homeserver" }}"
DATE="$(date +%Y-%m-%d_%H%M%S)"
BACKUP_PATH="${BACKUP_DIR}/${DATE}"
COMPOSE_PROJECT="{{ .Get "core/compose-project-name" | default "home-server" }}"
RETAIN_DAYS="{{ .Get "core/backup-retain-days" | default "7" }}"

mkdir -p "${BACKUP_PATH}"
echo "[$(date)] Starting backup to ${BACKUP_PATH}"

{{- if .ComponentEnabled "mariadb" }}

# ── MariaDB ──────────────────────────────────────────────────────────────
echo "[$(date)] Backing up MariaDB..."
docker exec mariadb mariadb-dump \
  -u root -p'{{ .Get "mariadb/root-password" }}' \
  --all-databases --single-transaction --quick \
  > "${BACKUP_PATH}/mariadb-all-databases.sql"
echo "[$(date)] MariaDB backup complete ($(du -h "${BACKUP_PATH}/mariadb-all-databases.sql" | cut -f1))"
{{- end }}

{{- if .ComponentEnabled "nextcloud" }}

# ── Nextcloud ────────────────────────────────────────────────────────────
echo "[$(date)] Backing up Nextcloud..."
docker exec -u www-data nextcloud php occ maintenance:mode --on
rsync -a --delete \
  "{{ .Get "core/data-root" | default "/srv/homeserver" }}/nextcloud/" \
  "${BACKUP_PATH}/nextcloud/"
docker exec -u www-data nextcloud php occ maintenance:mode --off
echo "[$(date)] Nextcloud backup complete ($(du -sh "${BACKUP_PATH}/nextcloud/" | cut -f1))"
{{- end }}

{{- if .ComponentEnabled "pihole" }}

# ── PiHole ───────────────────────────────────────────────────────────────
echo "[$(date)] Backing up PiHole..."
docker exec pihole pihole -a -t 2>/dev/null || true
# Copy the teleporter archive from the container
PIHOLE_BACKUP=$(docker exec pihole ls -t /tmp/pi-hole-*.tar.gz 2>/dev/null | head -1)
if [ -n "${PIHOLE_BACKUP}" ]; then
  docker cp "pihole:${PIHOLE_BACKUP}" "${BACKUP_PATH}/pihole-teleporter.tar.gz"
  echo "[$(date)] PiHole backup complete"
else
  echo "[$(date)] WARNING: PiHole teleporter export failed, copying config volume instead"
  docker cp pihole:/etc/pihole/ "${BACKUP_PATH}/pihole-config/"
fi
{{- end }}

# ── Cleanup old backups ─────────────────────────────────────────────────
echo "[$(date)] Cleaning up backups older than ${RETAIN_DAYS} days..."
find "${BACKUP_DIR}" -maxdepth 1 -type d -mtime +"${RETAIN_DAYS}" -exec rm -rf {} +

echo "[$(date)] Backup complete: ${BACKUP_PATH}"
echo "[$(date)] Disk usage: $(du -sh "${BACKUP_PATH}" | cut -f1)"
